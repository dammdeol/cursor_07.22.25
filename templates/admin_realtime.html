{% extends "base.html" %}

{% block title %}Administración Real-Time - Catálogo Ralph Wilson{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-broadcast-tower"></i> Panel de Administración Real-Time
            </h1>
            <p class="text-muted">Conexión en tiempo real con ralphwilson.com.mx</p>
        </div>
    </div>
    
    <!-- Real-Time vs Cached Toggle -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-satellite-dish"></i> Modo de Operación
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-wifi fa-2x text-success me-3"></i>
                                <div>
                                    <h6>Tiempo Real</h6>
                                    <small class="text-muted">Datos directos desde ralphwilson.com.mx</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-database fa-2x text-primary me-3"></i>
                                <div>
                                    <h6>Cache Local</h6>
                                    <small class="text-muted">{{ cached_stats.total_products }} productos en cache</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-Time Scraping Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-download"></i> Scraping en Tiempo Real
                    </h5>
                </div>
                <div class="card-body">
                    {% if not scraping_in_progress %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Iniciar Scraping Real-Time</h6>
                            <p class="text-muted">
                                Extrae datos directamente desde ralphwilson.com.mx con barra de progreso en tiempo real.
                            </p>
                            
                            <form method="POST" action="{{ url_for('start_realtime_scraping') }}" class="mb-3">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="save_to_db" name="save_to_db" value="true">
                                    <label class="form-check-label" for="save_to_db">
                                        Guardar en cache local (opcional)
                                    </label>
                                </div>
                                
                                <button type="submit" class="btn btn-success btn-lg" id="startRealtimeBtn">
                                    <i class="fas fa-satellite-dish"></i> Iniciar Scraping Real-Time
                                </button>
                            </form>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Características del Scraping Real-Time:</h6>
                                <ul class="mb-0">
                                    <li>Conexión directa al sitio web</li>
                                    <li>Barra de progreso en tiempo real</li>
                                    <li>Detección automática de productos descontinuados</li>
                                    <li>No requiere almacenamiento continuo</li>
                                    <li>Datos siempre actualizados</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center">
                        <h6><i class="fas fa-spinner fa-spin"></i> Scraping en Progreso...</h6>
                        <p class="text-muted">Conectando en tiempo real con ralphwilson.com.mx</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Progress Bar Section -->
    <div class="row mb-4" id="progressSection" style="display: none;">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Progreso en Tiempo Real
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span id="progressLabel">Iniciando...</span>
                            <span id="progressPercentage">0%</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Progress Details -->
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 id="totalProducts">0</h5>
                                <small class="text-muted">Total Productos</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 id="processedProducts">0</h5>
                                <small class="text-muted">Procesados</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 id="timeRemaining">--</h5>
                                <small class="text-muted">Tiempo Restante</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h5 id="currentStatus">--</h5>
                                <small class="text-muted">Estado Actual</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Product -->
                    <div class="mt-3">
                        <h6>Producto Actual:</h6>
                        <div class="alert alert-light mb-0" id="currentProduct">
                            Esperando...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title">Cache Local</h5>
                            <h2 class="mb-0">{{ cached_stats.total_products }}</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title">Conexión</h5>
                            <h2 class="mb-0"><i class="fas fa-wifi"></i></h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-satellite-dish fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title">Descontinuados</h5>
                            <h2 class="mb-0">{{ cached_stats.discontinued_products }}</h2>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-eye"></i> Ver Datos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('products', realtime='true') }}" class="btn btn-success">
                            <i class="fas fa-broadcast-tower"></i> Ver Productos en Tiempo Real
                        </a>
                        <a href="{{ url_for('products', realtime='false') }}" class="btn btn-primary">
                            <i class="fas fa-database"></i> Ver Cache Local
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tools"></i> Gestión
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <form method="POST" action="{{ url_for('clear_cache') }}" class="d-inline" 
                              onsubmit="return confirm('¿Limpiar cache local?')">
                            <button type="submit" class="btn btn-warning w-100">
                                <i class="fas fa-trash"></i> Limpiar Cache Local
                            </button>
                        </form>
                        <button class="btn btn-info" onclick="testConnection()">
                            <i class="fas fa-heartbeat"></i> Probar Conexión
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Connection Status -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-signal"></i> Estado de Conexión en Tiempo Real
                    </h5>
                </div>
                <div class="card-body">
                    <div id="connectionStatus">
                        <div class="d-flex justify-content-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Verificando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let progressInterval;
let isScrapingInProgress = {{ 'true' if scraping_in_progress else 'false' }};

// Start progress monitoring if scraping is in progress
if (isScrapingInProgress) {
    startProgressMonitoring();
}

function startProgressMonitoring() {
    document.getElementById('progressSection').style.display = 'block';
    
    progressInterval = setInterval(updateProgress, 1000);
}

function updateProgress() {
    fetch('/api/scraping/progress')
        .then(response => response.json())
        .then(data => {
            if (data.in_progress && data.progress) {
                const progress = data.progress;
                
                // Update progress bar
                const percentage = Math.round(progress.progress_percentage || 0);
                document.getElementById('progressBar').style.width = percentage + '%';
                document.getElementById('progressPercentage').textContent = percentage + '%';
                document.getElementById('progressLabel').textContent = progress.current_step || 'Procesando...';
                
                // Update details
                document.getElementById('totalProducts').textContent = progress.total_products || 0;
                document.getElementById('processedProducts').textContent = progress.processed_products || 0;
                
                // Format time remaining
                const timeRemaining = progress.estimated_time_remaining;
                if (timeRemaining && timeRemaining > 0) {
                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = Math.floor(timeRemaining % 60);
                    document.getElementById('timeRemaining').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('timeRemaining').textContent = '--';
                }
                
                // Update current product
                if (progress.current_product) {
                    document.getElementById('currentProduct').innerHTML = 
                        `<i class="fas fa-cog fa-spin"></i> ${progress.current_product}`;
                }
                
                // Update status
                if (percentage >= 100) {
                    document.getElementById('currentStatus').innerHTML = 
                        '<i class="fas fa-check text-success"></i> Completado';
                    clearInterval(progressInterval);
                    
                    // Reload page after completion
                    setTimeout(() => {
                        location.reload();
                    }, 3000);
                } else {
                    document.getElementById('currentStatus').innerHTML = 
                        '<i class="fas fa-spinner fa-spin text-primary"></i> Activo';
                }
            } else {
                // Scraping not in progress
                if (progressInterval) {
                    clearInterval(progressInterval);
                    document.getElementById('progressSection').style.display = 'none';
                }
            }
        })
        .catch(error => {
            console.error('Error updating progress:', error);
        });
}

// Start button handler
document.getElementById('startRealtimeBtn')?.addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Iniciando Conexión...';
    
    setTimeout(() => {
        startProgressMonitoring();
    }, 2000);
});

// Test connection function
function testConnection() {
    const statusDiv = document.getElementById('connectionStatus');
    statusDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Probando conexión...</div>';
    
    fetch('/api/products/realtime?limit=1')
        .then(response => response.json())
        .then(data => {
            if (data.products) {
                statusDiv.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 
                        <strong>Conexión Exitosa</strong><br>
                        <small>Conectado a ralphwilson.com.mx - Última actualización: ${new Date().toLocaleString()}</small>
                    </div>
                `;
            } else {
                throw new Error('No data received');
            }
        })
        .catch(error => {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>Error de Conexión</strong><br>
                    <small>No se pudo conectar con ralphwilson.com.mx</small>
                </div>
            `;
        });
}

// Test connection on page load
testConnection();
</script>
{% endblock %}
